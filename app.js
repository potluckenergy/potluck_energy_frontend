var express = require('express');
var routes = require('./routes');
var logfmt = require("logfmt");
var exphbs = require('express3-handlebars');
var app = express();


///////////////////////////////////////////////////////////////////
//  logging ///////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////
app.use(logfmt.requestLogger());


///////////////////////////////////////////////////////////////////
//  static  ///////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////
app.use(express.compress());
app.use(express.static(__dirname + '/public'));


///////////////////////////////////////////////////////////////////
//  handlebars templating engine  /////////////////////////////////
///////////////////////////////////////////////////////////////////
app.engine('handlebars', exphbs({defaultLayout: 'main'}));
app.set('view engine', 'handlebars');


///////////////////////////////////////////////////////////////////
//  routing  //////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////
var appRoutes = [
  '/dashboard',
  '/projects',
  '/project',
  '/project*',
  '/initiate'
];

appRoutes.forEach( function(r) {
  app.get(r, routes.index);
});

//  other routes
app.get('/', routes.landing);
app.get('/about', routes.about);
app.get('/legal', routes.legal);
app.get('/logout', routes.logout);

//  api resources
app.get('/api/users', routes.users);


///////////////////////////////////////////////////////////////////
//  Error handling  ///////////////////////////////////////////////
///////////////////////////////////////////////////////////////////
app.get('*', function(req, res, next) {
  var err = new Error();
  err.status = 404;
  next(err);
});

app.use(function(err, req, res, next) {
  //  handling 404 errors
  if(err.status !== 404) {
    return next();
  }
  res.render('404', {layout:'static'});
});



///////////////////////////////////////////////////////////////////
//  server  ///////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////
var port = Number(process.env.PORT || 5000);
app.listen(port, function() {
  console.log("Listening on " + port);
});

